---
import { getLangFromUrl, useTranslations } from '../i18n/ui';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const currentPath = Astro.url.pathname;
const basePath = lang === 'es' ? '/es' : '';

const services = [
  { href: `${basePath}/services/corporate-film`, label: lang === 'es' ? 'Video Corporativo' : 'Corporate Film' },
  { href: `${basePath}/services/podcasts`, label: lang === 'es' ? 'Podcasts y Entrevistas' : 'Podcasts & Interviews' },
  { href: `${basePath}/services/events`, label: lang === 'es' ? 'Eventos Corporativos' : 'Corporate Events' },
  { href: `${basePath}/services/social-media`, label: lang === 'es' ? 'Contenido para Redes' : 'Social Media Content' },
  { href: `${basePath}/services/streaming`, label: lang === 'es' ? 'Streaming en Vivo' : 'Live Streaming' },
  { href: `${basePath}/services/real-estate-3d`, label: lang === 'es' ? 'Inmobiliario 3D' : '3D Real Estate' },
];

const navLinks = [
  { href: `${basePath}/portfolio`, label: t('nav.portfolio') },
  { href: `${basePath}/about`, label: t('nav.about') },
  { href: `${basePath}/contact`, label: t('nav.contact') },
];

const langSwitchHref = lang === 'es'
  ? currentPath.replace(/^\/es/, '') || '/'
  : `/es${currentPath}`;
---

<nav id="navbar" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300">
  <div class="container h-20 md:h-24 flex items-center justify-between">
    <!-- Logo -->
    <a href={`${basePath}/`} class="relative z-50 flex items-center shrink-0" aria-label="Tecnovisuales">
      <img
        src="/logo-dark.png"
        alt="Tecnovisuales"
        width="180"
        height="40"
        class="h-9 w-auto max-h-12 md:h-10 md:max-h-14 object-contain object-left"
        loading="eager"
        fetchpriority="high"
      />
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden lg:flex items-center gap-8">
      <!-- Services Dropdown -->
      <div class="relative group">
        <button class="flex items-center gap-1 text-sm font-medium uppercase tracking-[0.15em] text-brand-gray-light hover:text-brand-gold transition-colors py-2">
          {t('nav.services')}
          <svg class="w-3 h-3 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <!-- Dropdown Menu -->
        <div class="absolute top-full left-0 pt-4 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300">
          <div class="bg-brand-black-light border border-brand-gray-dark/30 min-w-[280px] py-3 shadow-lg">
            {services.map((service) => (
              <a
                href={service.href}
                class="block px-8 py-3 text-sm text-brand-gray-light hover:text-brand-gold hover:bg-brand-black transition-colors"
              >
                {service.label}
              </a>
            ))}
            <div class="border-t border-brand-gray-dark/30 mt-3 pt-3">
              <a
                href={`${basePath}/services`}
                class="block px-8 py-3 text-sm font-medium text-brand-gold hover:bg-brand-black transition-colors"
              >
                {lang === 'es' ? 'Ver Todos los Servicios' : 'View All Services'} →
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Other Links -->
      {navLinks.map((link) => (
        <a
          href={link.href}
          class="text-sm font-medium uppercase tracking-[0.15em] text-brand-gray-light hover:text-brand-gold transition-colors"
        >
          {link.label}
        </a>
      ))}

      <!-- Language Toggle -->
      <a
        href={langSwitchHref}
        class="ml-8 px-4 py-1.5 border border-brand-gray-dark text-xs font-medium uppercase tracking-[0.15em] text-brand-gray-light hover:border-brand-gold hover:text-brand-gold transition-colors"
      >
        {lang === 'es' ? 'EN' : 'ES'}
      </a>
    </div>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-btn"
      class="lg:hidden relative z-50 w-10 h-10 flex items-center justify-center text-brand-cream hover:text-brand-gold transition-colors"
      aria-label="Toggle menu"
    >
      <div class="hamburger w-6 h-5 relative flex flex-col justify-between">
        <span class="block w-full h-px bg-current transition-all duration-300 origin-left"></span>
        <span class="block w-full h-px bg-current transition-all duration-300"></span>
        <span class="block w-3/4 self-end h-px bg-current transition-all duration-300 origin-left"></span>
      </div>
    </button>
  </div>

  <!-- Mobile Menu Overlay -->
  <div id="mobile-menu" class="fixed inset-0 z-40 bg-brand-black/98 backdrop-blur-xl opacity-0 invisible transition-all duration-500 lg:hidden flex items-center justify-center">
    <div class="container h-full flex flex-col justify-center py-20 overflow-y-auto">
      <nav class="space-y-8">
        <!-- Services -->
        <div>
          <p class="text-xs font-medium uppercase tracking-[0.2em] text-brand-gray mb-6">{t('nav.services')}</p>
          <div class="flex flex-col gap-4 pl-4 border-l border-brand-gray-dark/30">
            {services.map((service) => (
              <a
                href={service.href}
                class="text-2xl font-display text-brand-cream hover:text-brand-gold transition-colors"
              >
                {service.label}
              </a>
            ))}
          </div>
        </div>

        <!-- Divider -->
        <div class="w-20 h-px bg-brand-gray-dark/50 my-8"></div>

        <!-- Other Links -->
        <div class="flex flex-col gap-6">
          {navLinks.map((link) => (
            <a
              href={link.href}
              class="text-3xl md:text-4xl font-display text-brand-cream hover:text-brand-gold transition-colors"
            >
              {link.label}
            </a>
          ))}
        </div>

        <!-- Language Toggle -->
        <div class="pt-8">
            <a
            href={langSwitchHref}
            class="inline-block px-8 py-3 border border-brand-gray-dark text-sm font-medium uppercase tracking-[0.15em] text-brand-gray-light hover:border-brand-gold hover:text-brand-gold transition-colors"
            >
            {lang === 'es' ? 'Switch to English' : 'Cambiar a Español'}
            </a>
        </div>
      </nav>
    </div>
  </div>
</nav>

<script>
  // Navbar scroll effect
  const navbar = document.getElementById('navbar');
  let lastScroll = 0;

  function updateNavbar() {
    const currentScroll = window.scrollY;

    if (currentScroll > 50) {
      navbar?.classList.add('bg-brand-black/90', 'backdrop-blur-md', 'border-b', 'border-brand-gray-dark/10');
    } else {
      navbar?.classList.remove('bg-brand-black/90', 'backdrop-blur-md', 'border-b', 'border-brand-gray-dark/10');
    }

    lastScroll = currentScroll;
  }

  window.addEventListener('scroll', updateNavbar, { passive: true });
  updateNavbar();

  // Mobile menu toggle
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const hamburgerSpans = mobileMenuBtn?.querySelectorAll('span');
  let isMenuOpen = false;

  function toggleMenu() {
    isMenuOpen = !isMenuOpen;
    const body = document.body;

    if (isMenuOpen) {
      mobileMenu?.classList.remove('opacity-0', 'invisible');
      mobileMenu?.classList.add('opacity-100', 'visible');
      body.style.overflow = 'hidden';

      // Animate hamburger to X
      if (hamburgerSpans) {
        hamburgerSpans[0].classList.add('rotate-45', 'translate-y-[1px]');
        hamburgerSpans[1].classList.add('opacity-0');
        hamburgerSpans[2].classList.add('-rotate-45', '-translate-y-[1px]', 'w-full');
      }
    } else {
      mobileMenu?.classList.add('opacity-0', 'invisible');
      mobileMenu?.classList.remove('opacity-100', 'visible');
      body.style.overflow = '';

      // Reset hamburger
      if (hamburgerSpans) {
        hamburgerSpans[0].classList.remove('rotate-45', 'translate-y-[1px]');
        hamburgerSpans[1].classList.remove('opacity-0');
        hamburgerSpans[2].classList.remove('-rotate-45', '-translate-y-[1px]', 'w-full', 'w-3/4');
        hamburgerSpans[2].classList.add('w-3/4');
      }
    }
  }

  mobileMenuBtn?.addEventListener('click', toggleMenu);

  // Close menu on link click
  mobileMenu?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => {
      if (isMenuOpen) toggleMenu();
    });
  });

  // Close menu on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isMenuOpen) toggleMenu();
  });
</script>
